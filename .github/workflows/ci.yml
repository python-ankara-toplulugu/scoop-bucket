name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Lint manifests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Validate JSON syntax
        run: |
          for file in bucket/*.json; do
            echo "Validating $file..."
            python -m json.tool "$file" > /dev/null
          done

  discover:
    name: Discover packages
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      packages: ${{ steps.find.outputs.packages }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Find all packages
        id: find
        run: |
          # Get all package names (without .json extension)
          packages=$(ls bucket/*.json 2>/dev/null | xargs -n1 basename | sed 's/\.json$//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "packages=$packages" >> "$GITHUB_OUTPUT"
          echo "Found packages: $packages"

  test:
    name: Test ${{ matrix.package }}
    runs-on: windows-latest
    timeout-minutes: 30
    needs: [lint, discover]
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.discover.outputs.packages) }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Scoop and dependencies
        shell: pwsh
        run: |
          # Install Scoop
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
          irm get.scoop.sh | iex

          # Add Scoop to PATH for this session
          $env:Path = "$env:USERPROFILE\scoop\shims;$env:Path"

          # Add extras bucket and install pipx
          scoop bucket add extras
          scoop install pipx
          pipx ensurepath

      - name: Add local bucket
        shell: pwsh
        run: |
          # Scoop expects a Git URL for bucket add, so for local testing
          # we manually copy the bucket files to Scoop's bucket directory
          $bucketDir = "$env:USERPROFILE\scoop\buckets\python-ankara-toplulugu"
          New-Item -ItemType Directory -Path "$bucketDir\bucket" -Force
          Copy-Item -Path "${{ github.workspace }}\bucket\*" -Destination "$bucketDir\bucket\" -Recurse

      - name: Install ${{ matrix.package }}
        shell: pwsh
        run: |
          $env:Path = "$env:USERPROFILE\scoop\shims;$env:Path"
          scoop install python-ankara-toplulugu/${{ matrix.package }}

      - name: Test ${{ matrix.package }}
        shell: pwsh
        run: |
          # Add Scoop and pipx to PATH
          $env:Path = "$env:USERPROFILE\scoop\shims;$env:USERPROFILE\.local\bin;$env:Path"

          # Test the command
          ${{ matrix.package }} --help
          ${{ matrix.package }} --version

  checkver:
    name: Check versions
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Check all package versions against PyPI
        run: |
          has_mismatch=false

          for manifest in bucket/*.json; do
            package=$(basename "$manifest" .json)

            # Get version from manifest
            manifest_version=$(python -c "import json; print(json.load(open('$manifest'))['version'])")

            # Get version from PyPI
            pypi_version=$(curl -s "https://pypi.org/pypi/$package/json" | python -c "import sys, json; print(json.load(sys.stdin)['info']['version'])" 2>/dev/null || echo "NOT_FOUND")

            echo "Package: $package"
            echo "  Manifest: $manifest_version"
            echo "  PyPI: $pypi_version"

            if [ "$pypi_version" = "NOT_FOUND" ]; then
              echo "::warning::Package $package not found on PyPI"
            elif [ "$pypi_version" != "$manifest_version" ]; then
              echo "::warning::Version mismatch for $package! PyPI has $pypi_version but manifest has $manifest_version"
              has_mismatch=true
            else
              echo "  âœ“ Versions match"
            fi
            echo ""
          done

          if [ "$has_mismatch" = true ]; then
            echo "::notice::Some packages have version mismatches. Consider updating the manifests."
          fi
