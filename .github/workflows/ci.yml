name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: Lint manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          for file in bucket/*.json; do
            echo "Validating $file..."
            python -m json.tool "$file" > /dev/null
          done

  test:
    name: Test on Windows
    runs-on: windows-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install Scoop
        shell: pwsh
        run: |
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
          irm get.scoop.sh | iex

      - name: Add bucket and install pipx
        shell: pwsh
        run: |
          # Add extras bucket for pipx
          scoop bucket add extras
          scoop install pipx
          pipx ensurepath

      - name: Add this bucket
        shell: pwsh
        run: |
          scoop bucket add python-ankara-toplulugu ${{ github.workspace }}

      - name: Install ossin
        shell: pwsh
        run: |
          scoop install python-ankara-toplulugu/ossin

      - name: Test ossin
        shell: pwsh
        run: |
          # Refresh PATH to include pipx binaries
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

          # Also add pipx default location
          $pipxBin = "$env:USERPROFILE\.local\bin"
          if (Test-Path $pipxBin) {
            $env:Path += ";$pipxBin"
          }

          # Test the command
          ossin --help
          ossin --version

  checkver:
    name: Check for updates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check ossin version on PyPI
        run: |
          PYPI_VERSION=$(curl -s https://pypi.org/pypi/ossin/json | python -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
          MANIFEST_VERSION=$(python -c "import json; print(json.load(open('bucket/ossin.json'))['version'])")

          echo "PyPI version: $PYPI_VERSION"
          echo "Manifest version: $MANIFEST_VERSION"

          if [ "$PYPI_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "::warning::Version mismatch! PyPI has $PYPI_VERSION but manifest has $MANIFEST_VERSION"
          else
            echo "Versions match!"
          fi
