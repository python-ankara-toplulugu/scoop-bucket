name: Update Manifests

on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      package:
        description: "Specific package to update (leave empty for all)"
        required: false
        type: string
      dry_run:
        description: "Dry run (check only, no PR)"
        required: false
        type: boolean
        default: false

jobs:
  check-updates:
    name: Check for updates
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      updates: ${{ steps.check.outputs.updates }}
      has_updates: ${{ steps.check.outputs.has_updates }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Check for manifest updates
        id: check
        run: |
          updates="[]"
          target_package="${{ inputs.package }}"

          for manifest in bucket/*.json; do
            package=$(basename "$manifest" .json)

            # Skip if targeting a specific package and this isn't it
            if [ -n "$target_package" ] && [ "$package" != "$target_package" ]; then
              continue
            fi

            # Get version from manifest
            manifest_version=$(python -c "import json; print(json.load(open('$manifest'))['version'])")

            # Get version from PyPI
            pypi_version=$(curl -s "https://pypi.org/pypi/$package/json" | python -c "import sys, json; print(json.load(sys.stdin)['info']['version'])" 2>/dev/null || echo "NOT_FOUND")

            echo "Package: $package"
            echo "  Manifest: $manifest_version"
            echo "  PyPI: $pypi_version"

            if [ "$pypi_version" = "NOT_FOUND" ]; then
              echo "  Skipping: not found on PyPI"
              continue
            fi

            if [ "$pypi_version" != "$manifest_version" ]; then
              echo "  Update available!"
              # Append to JSON array
              updates=$(echo "$updates" | python -c "
          import sys, json
          data = json.load(sys.stdin)
          data.append({
              'package': '$package',
              'current_version': '$manifest_version',
              'latest_version': '$pypi_version'
          })
          print(json.dumps(data))
          ")
            else
              echo "  Up to date"
            fi
          done

          echo "updates=$updates" >> "$GITHUB_OUTPUT"

          # Check if there are any updates
          count=$(echo "$updates" | python -c "import sys, json; print(len(json.load(sys.stdin)))")
          if [ "$count" -gt 0 ]; then
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
            echo "Found $count package(s) with updates available"
          else
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
            echo "All packages are up to date"
          fi

  update-manifests:
    name: Update manifests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true' && inputs.dry_run != true
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"

      - name: Update manifests
        id: update
        run: |
          updates='${{ needs.check-updates.outputs.updates }}'
          > /tmp/updates.txt

          echo "$updates" | python -c "
          import sys, json

          updates = json.load(sys.stdin)
          for update in updates:
              package = update['package']
              version = update['latest_version']
              manifest_path = f'bucket/{package}.json'

              # Update manifest
              with open(manifest_path, 'r') as f:
                  data = json.load(f)
              data['version'] = version
              with open(manifest_path, 'w') as f:
                  json.dump(data, f, indent=4)
                  f.write('\n')

              print(f'Updated {package}: {update[\"current_version\"]} → {version}')
          "

          # Generate PR body
          echo "$updates" | python -c "
          import sys, json
          updates = json.load(sys.stdin)
          for u in updates:
              print(f'- **{u[\"package\"]}**: {u[\"current_version\"]} → {u[\"latest_version\"]}')
          " > /tmp/updates.txt

      - name: Read updates list
        id: body
        run: |
          {
            echo 'content<<EOF'
            echo 'Automated package version updates from PyPI.'
            echo ''
            echo '## Updates'
            cat /tmp/updates.txt
            echo ''
            echo '---'
            echo '*This PR was automatically created by the update-manifests workflow.*'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update package versions"
          title: "chore: update package versions"
          body: ${{ steps.body.outputs.content }}
          branch: auto-update/packages
          delete-branch: true
          labels: automated,dependencies
